<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دفترچه یادداشت پیشرفته</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="//fdn.fontcdn.ir">
    <link rel="preconnect" href="//v1.fontapi.ir">
    <link href="https://v1.fontapi.ir/css/Estedad" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        :root {
            --md-icon-font: 'Material Symbols Outlined';
            --md-icon-size: 24px;
            --md-icon-weight: 400;
            --md-icon-fill: 0;
            --md-icon-grade: 0;
            --bg-start-light: #e0e7ff;
            --bg-end-light: #f0f2f5;
            --bg-start-dark: #111827;
            --bg-end-dark: #1e293b;
            --spoiler-bg-light: #d1d5db;
            --spoiler-text-light: #d1d5db;
            --spoiler-bg-dark: #374151;
            --spoiler-text-dark: #374151;
        }
        .material-symbols-outlined {
            font-family: var(--md-icon-font);
            font-weight: var(--md-icon-weight);
            font-style: normal;
            font-size: var(--md-icon-size);
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            vertical-align: middle;
        }
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body {
            font-family: 'Estedad', sans-serif;
            background: linear-gradient(-45deg, var(--bg-start-light), var(--bg-end-light), #c7d2fe, #e0e7ff);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            transition: background-color 0.5s, color 0.5s;
        }
        .dark body {
            background: linear-gradient(-45deg, var(--bg-start-dark), var(--bg-end-dark), #0f172a, #111827);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-card {
            background: rgba(26, 32, 44, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .note-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 10px -2px rgba(0,0,0,0.04);
        }
        .note-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #a0aec0; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; }
        .hidden { display: none !important; }
        .note-editor {
            min-height: 200px;
            max-height: 50vh; /* Control max height */
            overflow-y: auto; /* Add scroll for long content */
            padding: 1rem;
            border-radius: 0.5rem;
            outline: none;
            transition: border-color 0.2s;
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
        }
        .dark .note-editor { background-color: #2d3748; border-color: #4a5568; }
        .note-editor:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        .note-editor a, .note-content-display a { color: #4f46e5; font-weight: 500; text-decoration: underline; text-decoration-thickness: 1px; }
        .dark .note-editor a, .dark .note-content-display a { color: #818cf8; }
        .modal-enter { transform: scale(0.95) translateY(15px); opacity: 0; }
        .modal-enter-active { transform: scale(1) translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-leave-active { transform: scale(0.95) translateY(15px); opacity: 0; transition: all 0.2s ease-in; }
        @keyframes shake { 10%, 90% { transform: translateX(-1px); } 20%, 80% { transform: translateX(2px); } 30%, 50%, 70% { transform: translateX(-4px); } 40%, 60% { transform: translateX(4px); } }
        .animate-shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }
        #unlock-modal { background: url('https://images.unsplash.com/photo-1554034483-04fda0d3507b?q=80&w=2670&auto=format&fit=crop') no-repeat center center/cover; }
        #unlock-modal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        
        /* Spoiler Style */
        .spoiler {
            background-color: var(--spoiler-bg-light);
            color: var(--spoiler-text-light);
            padding: 0 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.4s ease-in-out;
            user-select: none;
        }
        .dark .spoiler {
            background-color: var(--spoiler-bg-dark);
            color: var(--spoiler-text-dark);
        }
        .spoiler:hover {
            filter: brightness(1.1);
        }
        .spoiler.revealed {
            background-color: transparent;
            color: inherit;
            cursor: default;
            user-select: text;
        }

        /* Loading Spinner */
        #loading-overlay { transition: opacity 0.5s ease-out; }
        .spinner {
            width: 56px; height: 56px;
            border-radius: 50%;
            border: 8px solid;
            border-color: #dbdcef;
            border-right-color: #6366f1;
            animation: spinner-d3wgkg 1s infinite linear;
        }
        @keyframes spinner-d3wgkg { to { transform: rotate(1turn); } }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="text-gray-800 dark:text-gray-200 min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex justify-center items-center z-[200]">
        <div class="spinner"></div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow w-full">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-4xl text-indigo-500" style="--md-icon-size: 40px; --md-icon-fill: 1;">edit_note</span>
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-200">دفترچه یادداشت</h1>
                    <p class="text-sm text-gray-500 dark:text-gray-400">ایده‌های خود را اینجا ثبت و مدیریت کنید</p>
                </div>
            </div>
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative flex-grow">
                    <input type="text" id="search-box" placeholder="جستجو..." class="w-full pl-10 pr-4 py-2 rounded-full bg-white/80 dark:bg-gray-800/80 border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
                </div>
                <button id="theme-toggle-btn" class="p-2 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition" title="تغییر پوسته"></button>
                <button onclick="App.openLockSetupModal()" class="p-2 w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition" title="مدیریت قفل">
                    <span class="material-symbols-outlined">lock</span>
                </button>
            </div>
        </header>

        <div class="mb-8 p-4 glass-card rounded-2xl shadow-sm">
             <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <button onclick="App.openModal()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:shadow-indigo-500/50 transition transform hover:-translate-y-0.5 flex items-center gap-2 w-full sm:w-auto">
                    <span class="material-symbols-outlined">add</span> یادداشت جدید
                </button>
                <div class="flex items-center gap-2">
                    <button onclick="App.backupData()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:shadow-green-500/40 transition flex items-center gap-2" title="دانلود پشتیبان">
                        <span class="material-symbols-outlined">download</span>
                    </button>
                    <button onclick="App.triggerRestore()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:shadow-blue-500/40 transition flex items-center gap-2" title="بارگذاری پشتیبان">
                        <span class="material-symbols-outlined">upload</span>
                    </button>
                    <input type="file" id="restore-input" class="hidden" accept=".json" onchange="App.restoreData(event)">
                </div>
            </div>
             <div id="tag-filters" class="flex flex-wrap gap-2 justify-center mt-4"></div>
        </div>

        <main id="notes-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
    </div>
    
    <footer class="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
        <p>طراحی و توسعه با ❤️</p>
    </footer>

    <!-- Modals -->
    <div id="note-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col modal-enter" id="note-modal-content" style="max-height: 90vh;">
            <div class="p-6 flex-shrink-0">
                <input type="text" id="note-title" placeholder="عنوان یادداشت..." class="w-full text-2xl font-bold bg-transparent focus:outline-none mb-4 pb-2 border-b-2 border-gray-200 dark:border-gray-600">
                <div class="flex flex-wrap items-center gap-1 mb-4 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <button onclick="document.execCommand('bold')" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md" title="ضخیم"><span class="material-symbols-outlined">format_bold</span></button>
                    <button onclick="document.execCommand('italic')" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md" title="کج"><span class="material-symbols-outlined">format_italic</span></button>
                    <button onclick="document.execCommand('underline')" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md" title="زیرخط"><span class="material-symbols-outlined">format_underlined</span></button>
                    <button onclick="App.createLink()" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md" title="افزودن لینک"><span class="material-symbols-outlined">link</span></button>
                    <button onclick="App.formatSpoiler()" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md" title="اسپویلر"><span class="material-symbols-outlined">visibility_off</span></button>
                    <div class="relative">
                        <button onclick="this.nextElementSibling.click()" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md" title="تغییر رنگ متن"><span class="material-symbols-outlined">format_color_text</span></button>
                        <input type="color" onchange="App.changeTextColor(this.value)" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                    </div>
                </div>
            </div>
            <div class="px-6 pb-6 flex-grow overflow-y-auto">
                <!-- ***** FIX: Added contenteditable="true" back to the editor ***** -->
                <div id="note-editor" class="note-editor" contenteditable="true"></div>
                
                <!-- Attachment Section -->
                <div class="mt-4">
                    <h4 class="font-bold mb-2">فایل‌های ضمیمه:</h4>
                    <div id="note-attachments-list" class="space-y-2 max-h-32 overflow-y-auto p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <!-- Attachments will be listed here -->
                    </div>
                    <button onclick="App.triggerFileUpload()" class="mt-2 text-sm bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 py-2 px-4 rounded-lg flex items-center gap-2">
                        <span class="material-symbols-outlined" style="--md-icon-size: 20px;">attach_file</span>افزودن فایل
                    </button>
                    <input type="file" id="file-upload" class="hidden" onchange="App.uploadFile(event)">
                </div>
                
                <input type="text" id="note-tags" placeholder="برچسب‌ها (با کاما جدا کنید)..." class="w-full mt-4 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="p-6 flex-shrink-0 border-t dark:border-gray-700">
                <div class="flex justify-end gap-4">
                    <button onclick="App.closeModal()" class="py-2 px-5 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 transition">لغو</button>
                    <button onclick="App.saveNote()" class="py-2 px-5 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white transition">ذخیره</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="view-note-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-40 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl flex flex-col modal-enter" id="view-note-modal-content" style="max-height: 90vh;">
            <div class="p-6 md:p-8 flex-shrink-0">
                <h2 id="view-note-title" class="text-3xl font-bold border-b pb-3 dark:border-gray-600"></h2>
            </div>
            <div class="px-6 md:px-8 pb-6 flex-grow overflow-y-auto">
                <div id="view-note-content" class="prose dark:prose-invert max-w-none text-base leading-relaxed note-content-display"></div>
                <div id="view-note-attachments" class="mt-4"></div>
            </div>
            <div class="p-6 flex-shrink-0 border-t dark:border-gray-700">
                <div class="flex justify-end">
                    <button onclick="App.closeViewModal()" class="py-2 px-5 rounded-lg bg-gray-300 hover:bg-gray-400 dark:bg-gray-600 dark:hover:bg-gray-500 transition">بستن</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals (Lock, Confirm) -->
    <div id="unlock-modal" class="fixed inset-0 flex flex-col justify-center items-center z-[100] hidden">
        <div class="relative z-10 text-center p-8 glass-card rounded-2xl shadow-2xl w-full max-w-sm">
            <span class="material-symbols-outlined text-6xl text-white mb-4" style="--md-icon-size: 60px;">fingerprint</span>
            <h2 class="text-2xl font-bold mb-2 text-white">ورود امن</h2>
            <p class="text-gray-200 mb-6">برای دسترسی به یادداشت‌ها رمز عبور را وارد کنید.</p>
            <input type="password" id="unlock-password" placeholder="••••••••" class="w-full text-center tracking-widest p-3 rounded-lg bg-white/20 text-white placeholder-gray-300 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-white mb-4">
            <button onclick="App.unlock()" class="w-full py-3 rounded-lg bg-white/90 hover:bg-white text-indigo-600 font-bold transition">باز کردن قفل</button>
            <p id="unlock-hint" class="text-sm text-gray-300 mt-4"></p>
        </div>
    </div>
    <div id="lock-setup-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-50 hidden">
         <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm p-8 modal-enter" id="lock-setup-modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">تنظیمات قفل</h2>
            <div id="lock-setup-view">
                <p class="text-center text-gray-600 dark:text-gray-400 mb-6">یک رمز جدید برای حفاظت از یادداشت‌ها تنظیم کنید.</p>
                <input type="password" id="main-password" placeholder="رمز اصلی" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                <input type="text" id="helper-password" placeholder="رمز راهنما (اختیاری)" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                <div class="flex justify-center gap-4 mt-6">
                    <button onclick="App.closeLockSetupModal()" class="py-2 px-5 rounded-lg bg-gray-300 dark:bg-gray-600">لغو</button>
                    <button onclick="App.saveLockPassword()" class="py-2 px-5 rounded-lg bg-indigo-500 text-white">ذخیره رمز</button>
                </div>
            </div>
            <div id="remove-lock-view" class="hidden">
                <p class="text-center text-gray-600 dark:text-gray-400 mb-6">برای حذف قفل، رمز فعلی را وارد کنید.</p>
                <input type="password" id="remove-lock-password" placeholder="رمز فعلی" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                <div class="flex justify-center gap-4 mt-6">
                    <button onclick="App.closeLockSetupModal()" class="py-2 px-5 rounded-lg bg-gray-300 dark:bg-gray-600">لغو</button>
                    <button onclick="App.removeLock()" class="py-2 px-5 rounded-lg bg-red-600 text-white">حذف رمز</button>
                </div>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black/60 flex justify-center items-center p-4 z-[101] hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm p-6 text-center modal-enter" id="confirm-modal-content">
            <span id="confirm-icon" class="material-symbols-outlined text-5xl mb-4"></span>
            <h3 id="confirm-title" class="text-xl font-bold mb-2"></h3>
            <p id="confirm-message" class="text-gray-600 dark:text-gray-400 mb-6"></p>
            <div id="confirm-buttons" class="flex justify-center gap-4">
                <button id="confirm-cancel" class="py-2 px-6 rounded-lg bg-gray-300 dark:bg-gray-600">لغو</button>
                <button id="confirm-ok" class="py-2 px-6 rounded-lg bg-red-600 text-white">تایید</button>
            </div>
        </div>
    </div>

    <script>
    const App = {
        state: {
            notes: [], editingNoteId: null, settings: { theme: 'light' },
            lock: null, allTags: new Set(), activeTagFilter: null,
            savedSelection: null,
            tempAttachments: [] // For managing attachments during edit
        },
        elements: {},

        init() {
            this.cacheDOMElements();
            this.loadSettings();
            this.loadLock();
            if (this.state.lock) { this.showUnlockModal(); } 
            else { this.loadNotes(); this.addDefaultNote(); }
            this.setupEventListeners();
            setTimeout(() => {
                this.elements.loadingOverlay.style.opacity = '0';
                setTimeout(() => this.elements.loadingOverlay.classList.add('hidden'), 500);
            }, 500);
        },

        cacheDOMElements() {
            this.elements = {
                loadingOverlay: document.getElementById('loading-overlay'),
                notesContainer: document.getElementById('notes-container'),
                noteModal: document.getElementById('note-modal'),
                noteModalContent: document.getElementById('note-modal-content'),
                noteTitle: document.getElementById('note-title'),
                noteEditor: document.getElementById('note-editor'),
                noteTags: document.getElementById('note-tags'),
                noteAttachmentsList: document.getElementById('note-attachments-list'),
                themeToggleBtn: document.getElementById('theme-toggle-btn'),
                viewNoteModal: document.getElementById('view-note-modal'),
                viewNoteModalContent: document.getElementById('view-note-modal-content'),
                viewNoteTitle: document.getElementById('view-note-title'),
                viewNoteContent: document.getElementById('view-note-content'),
                viewNoteAttachments: document.getElementById('view-note-attachments'),
                unlockModal: document.getElementById('unlock-modal'),
                lockSetupModal: document.getElementById('lock-setup-modal'),
                lockSetupModalContent: document.getElementById('lock-setup-modal-content'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmModalContent: document.getElementById('confirm-modal-content'),
                appContainer: document.getElementById('app-container'),
                searchBox: document.getElementById('search-box'),
                tagFilters: document.getElementById('tag-filters'),
                restoreInput: document.getElementById('restore-input'),
                fileUpload: document.getElementById('file-upload'),
            };
        },
        
        setupEventListeners() {
            this.elements.themeToggleBtn.addEventListener('click', () => this.toggleTheme());
            this.elements.searchBox.addEventListener('input', () => this.renderNotes());
            this.elements.noteEditor.addEventListener('blur', () => this.saveSelection());
            // Add a single event listener for spoiler clicks
            document.addEventListener('click', (e) => {
                if (e.target.matches('.spoiler')) {
                    e.target.classList.add('revealed');
                }
            });
        },

        // --- DATA & NOTES LOGIC ---
        loadNotes() {
            const notesData = localStorage.getItem('notes');
            this.state.notes = notesData ? JSON.parse(notesData) : [];
            this.updateTags();
            this.renderNotes();
        },
        saveNotes() {
            localStorage.setItem('notes', JSON.stringify(this.state.notes));
            this.updateTags();
            this.renderNotes();
        },
        saveNote() {
            const title = this.elements.noteTitle.value.trim();
            const content = this.elements.noteEditor.innerHTML.trim();
            const tags = this.elements.noteTags.value.split(',').map(tag => tag.trim()).filter(Boolean);
            if (!title) {
                this.showAlert("خطا", "عنوان یادداشت نمی‌تواند خالی باشد.", "error");
                return;
            }

            const noteData = {
                title, content, tags,
                timestamp: new Date().toISOString(),
                attachments: [...this.state.tempAttachments]
            };

            if (this.state.editingNoteId) {
                const index = this.state.notes.findIndex(n => n.id === this.state.editingNoteId);
                if (index > -1) {
                    this.state.notes[index] = { ...this.state.notes[index], ...noteData };
                }
            } else {
                this.state.notes.push({ id: Date.now(), ...noteData, pinned: false });
            }
            this.saveNotes();
            this.closeModal();
        },
        confirmDelete(noteId, event) {
            event.stopPropagation();
            const note = this.state.notes.find(n => n.id === noteId);
            this.showConfirm("حذف یادداشت", `آیا از حذف یادداشت "${note.title}" مطمئن هستید؟`, () => this.deleteNote(noteId));
        },
        deleteNote(noteId) {
            this.state.notes = this.state.notes.filter(n => n.id !== noteId);
            this.saveNotes();
        },
        togglePin(noteId, event) {
            event.stopPropagation();
            const index = this.state.notes.findIndex(n => n.id === noteId);
            if (index > -1) {
                this.state.notes[index].pinned = !this.state.notes[index].pinned;
                this.saveNotes();
            }
        },

        // --- UI & RENDERING ---
        renderNotes() {
            this.elements.notesContainer.innerHTML = '';
            const searchTerm = this.elements.searchBox.value.toLowerCase();
            const filteredNotes = this.state.notes.filter(note => {
                const matchesSearch = note.title.toLowerCase().includes(searchTerm) || note.content.toLowerCase().includes(searchTerm) || (note.tags && note.tags.some(t => t.toLowerCase().includes(searchTerm)));
                const matchesTag = !this.state.activeTagFilter || (note.tags && note.tags.includes(this.state.activeTagFilter));
                return matchesSearch && matchesTag;
            });
            if (filteredNotes.length === 0) {
                this.elements.notesContainer.innerHTML = `<div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-12"><span class="material-symbols-outlined text-5xl mb-4">search_off</span><p>یادداشتی یافت نشد.</p></div>`;
                return;
            }
            const sortedNotes = [...filteredNotes].sort((a, b) => {
                if (a.pinned !== b.pinned) return a.pinned ? -1 : 1;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            sortedNotes.forEach(note => {
                const noteEl = document.createElement('div');
                noteEl.className = `note-card glass-card rounded-xl flex flex-col justify-between cursor-pointer`;
                const attachmentCount = note.attachments ? note.attachments.length : 0;
                noteEl.innerHTML = `
                    <div class="p-5 flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg truncate">${note.title}</h3>
                            <button class="pin-btn p-1 text-gray-400 hover:text-indigo-500 ${note.pinned ? 'text-indigo-500' : ''}" onclick="App.togglePin(${note.id}, event)"><span class="material-symbols-outlined" style="${note.pinned ? '--md-icon-fill: 1;' : ''}">push_pin</span></button>
                        </div>
                        <div class="text-gray-600 dark:text-gray-400 text-sm h-24 overflow-hidden relative"><div class="note-preview">${this.createPreview(note.content)}</div><div class="absolute bottom-0 left-0 w-full h-10 bg-gradient-to-t from-[rgba(255,255,255,0.6)] to-transparent dark:from-[rgba(26,32,44,0.6)]"></div></div>
                    </div>
                    <div class="border-t border-white/20 dark:border-gray-700/50 p-4 flex-shrink-0">
                         <div class="flex flex-wrap gap-2 mb-3 min-h-[28px]">${note.tags ? note.tags.map(tag => `<span class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-indigo-900 dark:text-indigo-300">${tag}</span>`).join('') : ''}</div>
                        <div class="flex justify-between items-center text-xs text-gray-400 dark:text-gray-500">
                            <div class="flex items-center gap-2">
                                ${attachmentCount > 0 ? `<span class="material-symbols-outlined" style="--md-icon-size: 16px;">attach_file</span><span>${attachmentCount}</span>` : ''}
                            </div>
                            <span>${new Date(note.timestamp).toLocaleDateString('fa-IR')}</span>
                            <div class="note-actions flex gap-1 items-center">
                                <button class="action-btn p-1 rounded-full hover:bg-gray-500/20" onclick="App.shareNote(${note.id}, event)" title="اشتراک‌گذاری"><span class="material-symbols-outlined text-green-500 hover:text-green-400">share</span></button>
                                <button class="action-btn p-1 rounded-full hover:bg-gray-500/20" onclick="App.openModal(${note.id}, event)" title="ویرایش"><span class="material-symbols-outlined text-blue-500 hover:text-blue-400">edit</span></button>
                                <button class="action-btn p-1 rounded-full hover:bg-gray-500/20" onclick="App.confirmDelete(${note.id}, event)" title="حذف"><span class="material-symbols-outlined text-red-500 hover:text-red-400">delete</span></button>
                            </div>
                        </div>
                    </div>`;
                noteEl.addEventListener('click', () => this.viewNote(note.id));
                this.elements.notesContainer.appendChild(noteEl);
            });
        },
        
        updateTags() {
            this.state.allTags.clear();
            this.state.notes.forEach(note => { if (note.tags) { note.tags.forEach(tag => this.state.allTags.add(tag)); } });
            this.renderTagFilters();
        },
        renderTagFilters() {
            this.elements.tagFilters.innerHTML = '';
            const allButton = document.createElement('button');
            allButton.textContent = 'همه';
            allButton.className = `px-3 py-1 rounded-full text-sm transition ${!this.state.activeTagFilter ? 'bg-indigo-500 text-white shadow-md' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`;
            allButton.onclick = () => { this.state.activeTagFilter = null; this.renderNotes(); this.renderTagFilters(); };
            this.elements.tagFilters.appendChild(allButton);
            this.state.allTags.forEach(tag => {
                const tagButton = document.createElement('button');
                tagButton.textContent = tag;
                tagButton.className = `px-3 py-1 rounded-full text-sm transition ${this.state.activeTagFilter === tag ? 'bg-indigo-500 text-white shadow-md' : 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'}`;
                tagButton.onclick = () => { this.state.activeTagFilter = tag; this.renderNotes(); this.renderTagFilters(); };
                this.elements.tagFilters.appendChild(tagButton);
            });
        },
        createPreview(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            // Replace spoilers with placeholder text for preview
            tempDiv.querySelectorAll('.spoiler').forEach(el => {
                el.textContent = '[محتوای مخفی]';
            });
            return tempDiv.textContent.trim().substring(0, 120);
        },

        // --- MODALS & DIALOGS ---
        openModal(noteId = null, event = null) {
            if (event) event.stopPropagation();
            this.state.editingNoteId = noteId;
            if (noteId) {
                const note = this.state.notes.find(n => n.id === noteId);
                this.elements.noteTitle.value = note.title;
                this.elements.noteEditor.innerHTML = note.content;
                this.elements.noteTags.value = note.tags ? note.tags.join(', ') : '';
                this.state.tempAttachments = note.attachments ? [...note.attachments] : [];
            } else {
                this.elements.noteTitle.value = ''; 
                this.elements.noteEditor.innerHTML = ''; 
                this.elements.noteTags.value = '';
                this.state.tempAttachments = [];
            }
            this.renderTempAttachments();
            this.elements.noteModal.classList.remove('hidden');
            setTimeout(() => this.elements.noteModalContent.classList.add('modal-enter-active'), 10);
        },
        closeModal() {
            this.elements.noteModalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                this.elements.noteModal.classList.add('hidden');
                this.elements.noteModalContent.classList.remove('modal-enter-active', 'modal-leave-active');
                this.state.editingNoteId = null;
                this.state.tempAttachments = [];
            }, 200);
        },
        viewNote(noteId) {
            const note = this.state.notes.find(n => n.id === noteId);
            this.elements.viewNoteTitle.textContent = note.title;
            this.elements.viewNoteContent.innerHTML = note.content;
            // Make sure spoilers are not revealed initially
            this.elements.viewNoteContent.querySelectorAll('.spoiler').forEach(el => el.classList.remove('revealed'));
            this.renderAttachmentsForView(note.attachments);
            this.elements.viewNoteModal.classList.remove('hidden');
            setTimeout(() => this.elements.viewNoteModalContent.classList.add('modal-enter-active'), 10);
        },
        closeViewModal() {
            this.elements.viewNoteModalContent.classList.add('modal-leave-active');
            setTimeout(() => {
                this.elements.viewNoteModal.classList.add('hidden');
                this.elements.viewNoteModalContent.classList.remove('modal-enter-active', 'modal-leave-active');
            }, 200);
        },
        
        showConfirm(title, message, onOk) { this._showDialog({ title, message, onOk, type: 'confirm' }); },
        showAlert(title, message, type = 'info', onOk = () => {}) { this._showDialog({ title, message, onOk, type }); },
        _showDialog({ title, message, onOk, type }) {
            const modal = this.elements.confirmModal;
            const content = this.elements.confirmModalContent;
            const iconEl = document.getElementById('confirm-icon');
            const titleEl = document.getElementById('confirm-title');
            const messageEl = document.getElementById('confirm-message');
            const buttonsEl = document.getElementById('confirm-buttons');
            const okBtn = document.getElementById('confirm-ok');
            const cancelBtn = document.getElementById('confirm-cancel');

            titleEl.textContent = title;
            messageEl.textContent = message;

            const icons = {
                confirm: { name: 'warning', color: 'text-red-500' },
                error: { name: 'error', color: 'text-red-500' },
                success: { name: 'check_circle', color: 'text-green-500' },
                info: { name: 'info', color: 'text-blue-500' },
            };
            const icon = icons[type] || icons.info;
            iconEl.textContent = icon.name;
            iconEl.className = `material-symbols-outlined ${icon.color} text-5xl mb-4`;
            
            if (type === 'confirm') {
                buttonsEl.classList.remove('hidden');
                okBtn.onclick = () => { onOk(); closeDialog(); };
                cancelBtn.onclick = () => closeDialog();
            } else {
                buttonsEl.classList.add('hidden');
                setTimeout(closeDialog, 2500);
            }
            
            const closeDialog = () => {
                content.classList.add('modal-leave-active');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    content.classList.remove('modal-enter-active', 'modal-leave-active');
                }, 200);
            };

            modal.classList.remove('hidden');
            setTimeout(() => content.classList.add('modal-enter-active'), 10);
        },
        
        // --- EDITOR & OTHER FEATURES ---
        saveSelection() { if (window.getSelection) { const sel = window.getSelection(); if (sel.getRangeAt && sel.rangeCount) { this.state.savedSelection = sel.getRangeAt(0); } } },
        restoreSelection() { if (this.state.savedSelection) { if (window.getSelection) { const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(this.state.savedSelection); } } },
        changeTextColor(color) { document.execCommand('foreColor', false, color); },
        createLink() { this.saveSelection(); const url = prompt("آدرس لینک را وارد کنید:", "https://"); this.restoreSelection(); if (url) { document.execCommand('createLink', false, url); } },
        formatSpoiler() {
            this.restoreSelection();
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const spoilerSpan = document.createElement('span');
            spoilerSpan.className = 'spoiler';
            
            // Check if we are wrapping existing content or creating a new spoiler
            if (range.toString().trim() === '') {
                spoilerSpan.innerHTML = '&nbsp;'; // Add space to make it clickable
            } else {
                spoilerSpan.appendChild(range.extractContents());
            }
            
            range.insertNode(spoilerSpan);
            selection.removeAllRanges(); // Deselect
        },
        addDefaultNote() {
            if (this.state.notes.length === 0) {
                this.state.notes.push({ id: Date.now(), title: "به دفترچه یادداشت پیشرفته خوش آمدید!", content: `<div>این یک یادداشت نمونه است. شما می‌توانید:</div><ul><li>یادداشت‌ها را <b>ویرایش</b> یا <u>حذف</u> کنید.</li><li>آن‌ها را <font color="#6366f1">سنجاق</font> کنید تا همیشه در بالا بمانند.</li><li>با دکمه‌های جدید می‌توانید از یادداشت‌ها <strong>پشتیبان</strong> بگیرید و آن را <strong>بازیابی</strong> کنید.</li><li>هر نوع فایلی (PDF, MP3, ...) را به یادداشت‌های خود <strong>ضمیمه</strong> کنید.</li><li>و حالا می‌توانید از <span class="spoiler">محتوای مخفی (اسپویلر)</span> هم استفاده کنید! (روی آن کلیک کنید)</li></ul>`, tags: ['آموزش', 'جدید'], timestamp: new Date().toISOString(), pinned: true, attachments: [] });
                this.saveNotes();
            }
        },
        async shareNote(noteId, event) {
            event.stopPropagation();
            const note = this.state.notes.find(n => n.id === noteId); if (!note) return;
            const tempDiv = document.createElement('div'); tempDiv.innerHTML = note.content;
            const textToShare = tempDiv.textContent || tempDiv.innerText || '';
            if (navigator.share) { try { await navigator.share({ title: note.title, text: textToShare }); } catch (err) { console.error('Error sharing:', err); } } 
            else { try { const textArea = document.createElement('textarea'); textArea.value = `${note.title}\n\n${textToShare}`; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); this.showAlert('کپی شد', 'متن یادداشت در کلیپ‌بورد کپی شد.', 'success'); } catch (err) { this.showAlert('خطا', 'امکان کپی کردن متن وجود ندارد.', 'error'); } }
        },
        
        // --- ATTACHMENT LOGIC ---
        triggerFileUpload() { this.elements.fileUpload.click(); },
        uploadFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { // 5MB warning
                this.showAlert('هشدار', 'فایل‌های بزرگ ممکن است باعث کندی برنامه شوند.', 'info');
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                this.state.tempAttachments.push({
                    name: file.name,
                    type: file.type,
                    data: e.target.result
                });
                this.renderTempAttachments();
            };
            reader.readAsDataURL(file);
            event.target.value = ''; // Reset input
        },
        renderTempAttachments() {
            this.elements.noteAttachmentsList.innerHTML = '';
            if (this.state.tempAttachments.length === 0) {
                this.elements.noteAttachmentsList.innerHTML = `<p class="text-xs text-gray-500 dark:text-gray-400 text-center p-2">هیچ فایلی ضمیمه نشده است.</p>`;
                return;
            }
            this.state.tempAttachments.forEach((file, index) => {
                const fileEl = document.createElement('div');
                fileEl.className = 'flex items-center justify-between bg-white dark:bg-gray-800 p-2 rounded';
                fileEl.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-300">${this.getFileIcon(file.type)}</span>
                        <span class="text-sm truncate">${file.name}</span>
                    </div>
                    <button onclick="App.removeTempAttachment(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full"><span class="material-symbols-outlined">delete</span></button>
                `;
                this.elements.noteAttachmentsList.appendChild(fileEl);
            });
        },
        removeTempAttachment(index) {
            this.state.tempAttachments.splice(index, 1);
            this.renderTempAttachments();
        },
        renderAttachmentsForView(attachments) {
            this.elements.viewNoteAttachments.innerHTML = '';
            if (!attachments || attachments.length === 0) return;

            const title = document.createElement('h4');
            title.className = 'font-bold mb-2 text-lg border-t pt-4 mt-4 dark:border-gray-600';
            title.textContent = 'فایل‌های ضمیمه:';
            this.elements.viewNoteAttachments.appendChild(title);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';

            attachments.forEach(file => {
                const container = document.createElement('div');
                container.className = 'bg-gray-100 dark:bg-gray-700 rounded-lg p-3';
                let content = '';

                if (file.type.startsWith('image/')) {
                    content = `<img src="${file.data}" class="max-h-48 w-full object-contain rounded-md mb-2">`;
                } else if (file.type.startsWith('audio/')) {
                    content = `<audio controls src="${file.data}" class="w-full mb-2"></audio>`;
                } else {
                    content = `<div class="flex items-center justify-center h-24 bg-gray-200 dark:bg-gray-600 rounded-md mb-2">
                                <span class="material-symbols-outlined text-5xl text-gray-500">${this.getFileIcon(file.type)}</span>
                               </div>`;
                }
                
                container.innerHTML = `
                    ${content}
                    <div class="flex items-center justify-between">
                        <p class="text-sm truncate font-medium">${file.name}</p>
                        <a href="${file.data}" download="${file.name}" class="p-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600" title="دانلود">
                            <span class="material-symbols-outlined" style="--md-icon-size: 20px;">download</span>
                        </a>
                    </div>
                `;
                grid.appendChild(container);
            });
            this.elements.viewNoteAttachments.appendChild(grid);
        },
        getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'image';
            if (fileType.startsWith('audio/')) return 'music_note';
            if (fileType.startsWith('video/')) return 'videocam';
            if (fileType === 'application/pdf') return 'picture_as_pdf';
            if (fileType.includes('zip') || fileType.includes('archive')) return 'folder_zip';
            return 'draft'; // Generic file icon
        },

        // --- BACKUP & RESTORE ---
        backupData() { const data = { notes: this.state.notes, settings: this.state.settings, lock: this.state.lock, }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, ''); a.download = `notes_backup_${timestamp}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); this.showAlert('موفقیت', 'فایل پشتیبان با موفقیت دانلود شد.', 'success'); },
        triggerRestore() { this.elements.restoreInput.click(); },
        restoreData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (data.notes && data.settings) { this.showConfirm('بازگردانی اطلاعات', 'تمام یادداشت‌ها و تنظیمات فعلی با اطلاعات فایل پشتیبان جایگزین خواهند شد. آیا ادامه می‌دهید؟', () => { this.state.notes = data.notes; this.state.settings = data.settings; this.state.lock = data.lock || null; this.saveNotes(); this.saveSettings(); this.saveLock(); this.showAlert('موفقیت', 'اطلاعات با موفقیت بازگردانی شد. صفحه دوباره بارگذاری می‌شود.', 'success'); setTimeout(() => window.location.reload(), 2000); }); } else { this.showAlert('خطا', 'فایل پشتیبان معتبر نیست.', 'error'); } } catch (error) { this.showAlert('خطا', 'خطا در خواندن فایل پشتیبان.', 'error'); console.error("Restore error:", error); } finally { event.target.value = ''; } }; reader.readAsText(file); },

        // --- THEME & SETTINGS ---
        toggleTheme() { this.state.settings.theme = this.state.settings.theme === 'light' ? 'dark' : 'light'; this.applyTheme(); this.saveSettings(); },
        applyTheme() { if (this.state.settings.theme === 'dark') { document.documentElement.classList.add('dark'); this.elements.themeToggleBtn.innerHTML = '<span class="material-symbols-outlined text-yellow-400">light_mode</span>'; } else { document.documentElement.classList.remove('dark'); this.elements.themeToggleBtn.innerHTML = '<span class="material-symbols-outlined">dark_mode</span>'; } },
        loadSettings() { const settingsData = localStorage.getItem('settings'); if (settingsData) { this.state.settings = JSON.parse(settingsData); } this.applyTheme(); },
        saveSettings() { localStorage.setItem('settings', JSON.stringify(this.state.settings)); },

        // --- LOCKING ---
        loadLock() { const lockData = localStorage.getItem('noteLock'); if (lockData) { this.state.lock = JSON.parse(lockData); } },
        saveLock() { if (this.state.lock) { localStorage.setItem('noteLock', JSON.stringify(this.state.lock)); } else { localStorage.removeItem('noteLock'); } },
        openLockSetupModal() { if(this.state.lock){ document.getElementById('lock-setup-view').classList.add('hidden'); document.getElementById('remove-lock-view').classList.remove('hidden'); document.getElementById('remove-lock-password').value=''; } else { document.getElementById('lock-setup-view').classList.remove('hidden'); document.getElementById('remove-lock-view').classList.add('hidden'); document.getElementById('main-password').value=''; document.getElementById('helper-password').value=''; } this.elements.lockSetupModal.classList.remove('hidden'); setTimeout(()=>this.elements.lockSetupModalContent.classList.add('modal-enter-active'), 10); },
        closeLockSetupModal() { this.elements.lockSetupModalContent.classList.add('modal-leave-active'); setTimeout(() => { this.elements.lockSetupModal.classList.add('hidden'); this.elements.lockSetupModalContent.classList.remove('modal-enter-active', 'modal-leave-active'); }, 200); },
        saveLockPassword() { const mainPass = document.getElementById('main-password').value; const helperPass = document.getElementById('helper-password').value; if (!mainPass) { this.showAlert("خطا", "رمز اصلی نمی‌تواند خالی باشد.", "error"); return; } this.state.lock = { password: mainPass, helper: helperPass }; this.saveLock(); this.closeLockSetupModal(); this.showAlert("موفقیت", "رمز با موفقیت تنظیم شد. صفحه قفل خواهد شد.", "success"); setTimeout(() => this.showUnlockModal(), 1500); },
        removeLock() { const enteredPass = document.getElementById('remove-lock-password').value; if (this.state.lock && enteredPass === this.state.lock.password) { this.state.lock = null; this.saveLock(); this.closeLockSetupModal(); this.showAlert("موفقیت", "قفل با موفقیت حذف شد.", "success"); } else { this.showAlert("خطا", "رمز وارد شده اشتباه است.", "error"); } },
        showUnlockModal() { this.elements.appContainer.classList.add('hidden'); this.elements.unlockModal.classList.remove('hidden'); document.getElementById('unlock-hint').textContent = this.state.lock.helper ? `راهنما: ${this.state.lock.helper}` : ''; },
        unlock() { const entered = document.getElementById('unlock-password').value; if (entered === this.state.lock.password) { this.elements.unlockModal.classList.add('hidden'); this.elements.appContainer.classList.remove('hidden'); document.getElementById('unlock-password').value = ''; this.loadNotes(); this.addDefaultNote(); } else { const unlockBtn = this.elements.unlockModal.querySelector('button'); unlockBtn.classList.add('animate-shake'); setTimeout(() => unlockBtn.classList.remove('animate-shake'), 820); } },
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    window.App = App;
    </script>
</body>
</html>